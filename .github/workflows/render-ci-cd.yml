name: CI/CD â€” VPS Deploy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (TypeScript)
        run: npm run build

      - name: Run tests
        run: npx jest --coverage --color
        env:
          CI: true

  deploy-to-vps:
    name: Deploy to VPS
    needs: build-and-test
    if: ${{ github.ref == 'refs/heads/main' && success() }}
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
      VPS_PORT: ${{ secrets.VPS_PORT }}
      REMOTE_PATH: ${{ secrets.VPS_REMOTE_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create release archive
        run: |
          tar --ignore-failed-read --exclude=.git --exclude=node_modules -czf release.tar.gz .

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Copy archive to VPS
        run: |
          PORT=${VPS_PORT:-22}
          if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ] || [ -z "$VPS_PASSWORD" ]; then
            echo "VPS secrets not set. Failing deploy step." >&2
            exit 1
          fi
          sshpass -p "$VPS_PASSWORD" scp -o StrictHostKeyChecking=no -P "$PORT" release.tar.gz "$VPS_USER"@"$VPS_HOST":/tmp/release.tar.gz

      - name: Extract and deploy on VPS
        run: |
          PORT=${VPS_PORT:-22}
          REMOTE=${VPS_USER}@${VPS_HOST}
          TARGET_DIR=${REMOTE_PATH:-/var/www/ott-my-list-service}
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$PORT" "$REMOTE" \
            "mkdir -p $TARGET_DIR && rm -rf $TARGET_DIR/* && tar -xzf /tmp/release.tar.gz -C $TARGET_DIR && cd $TARGET_DIR && npm ci && npm run build && npm run db:migrate && npm run db:seed && npm ci --production && (command -v pm2 >/dev/null 2>&1 || npm i -g pm2) && pm2 restart ott-my-list-service || pm2 start dist/server.js --name ott-my-list-service" 


